<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ðŸ’Ž CRM ZARA PLATINUM</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>body{margin:0;font-family:'Inter',sans-serif;height:100vh;display:flex;flex-direction:column;background:#d1d7db}.top-bar{background:#00a884;padding:0 20px;height:60px;display:flex;align-items:center;justify-content:space-between;color:white}.brand{font-weight:bold;font-size:1.2rem}.main-container{display:flex;flex:1;margin:20px;background:white;border-radius:5px;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,0.1)}.sidebar{width:350px;border-right:1px solid #e9edef;display:flex;flex-direction:column;background:#fff}.tabs{display:flex;background:#f0f2f5;border-bottom:1px solid #ddd}.tab{flex:1;text-align:center;padding:10px;cursor:pointer;color:#54656f;border-bottom:3px solid transparent}.tab.active{border-bottom:3px solid #00a884;color:#00a884;font-weight:bold}.search-box{padding:10px;background:#f0f2f5}.search-input{width:90%;padding:8px;border-radius:8px;border:none;background:white;display:block;margin:auto}.chat-list{flex:1;overflow-y:auto}.chat-item{padding:12px 15px;border-bottom:1px solid #f5f6f6;cursor:pointer;display:flex;align-items:center;gap:15px}.chat-item:hover{background:#f5f6f6}.chat-item.active{background:#f0f2f5}.avatar{width:45px;height:45px;background:#dfe5e7;border-radius:50%;display:flex;align-items:center;justify-content:center}.chat-info{flex:1;overflow:hidden}.chat-name{font-weight:600;color:#111b21}.chat-preview{font-size:0.85rem;color:#667781;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.unread-dot{width:20px;height:20px;background:#25d366;color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.7rem}.chat-area{flex:1;display:flex;flex-direction:column;background-color:#efeae2;background-image:url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png")}.chat-header{padding:10px 20px;background:#f0f2f5;height:60px;display:flex;justify-content:space-between;align-items:center}.messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:5px}.msg{max-width:65%;padding:6px 10px;border-radius:7px;font-size:0.9rem;position:relative;display:flex;flex-direction:column;box-shadow:0 1px 1px rgba(0,0,0,0.1)}.msg.zara{align-self:flex-end;background:#d9fdd3;border-top-right-radius:0}.msg.cliente{align-self:flex-start;background:#ffffff;border-top-left-radius:0}.msg.manual{align-self:flex-end;background:#fff;border:2px solid #d9fdd3;border-top-right-radius:0}.msg-time{font-size:0.65rem;color:#667781;align-self:flex-end}.footer{padding:10px;background:#f0f2f5;display:flex;gap:10px}.input-box{flex:1;padding:12px;border-radius:8px;border:none}.hidden{display:none!important}.tags-container{display:flex;gap:5px}.tag-btn{padding:5px 10px;border-radius:15px;border:none;font-size:0.75rem;cursor:pointer;font-weight:600}.tag-vma{background:#e3f2fd;color:#1565c0}.tag-body{background:#fff3e0;color:#e65100}.tag-pedido{background:#e8f5e9;color:#2e7d32}</style>
</head>
<body><div class="top-bar"><div class="brand">ðŸ’Ž ZARA CRM</div><div><a href="/" style="color:white;text-decoration:none;font-weight:bold">â—€ VOLVER AL PANEL</a></div></div><div class="main-container"><div class="sidebar"><div class="tabs"><div class="tab active" onclick="filterBy('all')">TODOS</div><div class="tab" onclick="filterBy('VMA')">VMA</div><div class="tab" onclick="filterBy('BodyElite')">BODY</div></div><div class="search-box"><input type="text" id="search" class="search-input" placeholder="Buscar..." onkeyup="renderList()"></div><div class="chat-list" id="chatList"></div></div><div class="chat-area"><div class="chat-header hidden" id="header"><div id="headerInfo"></div><div class="tags-container"><button class="tag-btn tag-vma" onclick="tag('VMA')">VMA</button><button class="tag-btn tag-body" onclick="tag('BodyElite')">BODY</button><button class="tag-btn tag-pedido" onclick="tag('Pedido')">PEDIDO</button></div></div><div class="messages" id="msgs"></div><div class="footer hidden" id="footer"><input type="text" class="input-box" id="input" placeholder="Escribe..." onkeypress="if(event.key==='Enter') send()"><button onclick="send()">âž¤</button></div></div></div>
<script>
let data={},active=null,filter='all';async function load(){try{const r=await fetch('/historial-chats');data=await r.json();renderList();if(active&&data[active])renderMsgs(active)}catch(e){}}
function filterBy(f){filter=f;document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));event.target.classList.add('active');renderList()}
function renderList(){const list=document.getElementById('chatList');const s=document.getElementById('search').value.toLowerCase();const keys=Object.keys(data).sort((a,b)=>{const tsA=data[a].lastTs||0;const tsB=data[b].lastTs||0;return tsB-tsA});let html="";keys.forEach(f=>{const c=data[f];const msgs=c.mensajes||c.messages||[];const last=msgs.length>0?msgs[msgs.length-1]:null;const txt=last?(last.texto||last.text||'...'):'...';if((filter==='all'||(c.tags||[]).includes(filter))&&(c.nombre.toLowerCase().includes(s)||f.includes(s))){html+=`<div class="chat-item ${active===f?'active':''}" onclick="select('${f}')"><div class="avatar">ðŸ‘¤</div><div class="chat-info"><div class="chat-name">${c.nombre}</div><div class="chat-preview">${txt}</div></div>${c.unread>0?`<div class="unread-dot">${c.unread}</div>`:''}</div>`}});if(html==="")html='<div style="padding:20px;text-align:center;color:#999">Sin mensajes</div>';if(list.innerHTML!==html&&document.activeElement.id!=='search')list.innerHTML=html}
function select(f){active=f;document.getElementById('header').classList.remove('hidden');document.getElementById('footer').classList.remove('hidden');fetch('/api/read',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({fono:f})});if(data[f])data[f].unread=0;renderList();renderMsgs(f)}
function renderMsgs(f){const c=data[f];document.getElementById('headerInfo').innerHTML=`<b>${c.nombre}</b><br><small>+${f}</small>`;const msgs=c.mensajes||c.messages||[];document.getElementById('msgs').innerHTML=msgs.map(m=>{const txt=m.texto||m.text||"";const h=m.hora||m.timestamp||"";const hs=h.includes(' ')?h.split(' ')[1]:h;let cl='cliente';if(m.from==='Zara'||m.role==='assistant')cl='zara';if(m.from&&m.from.includes('Manual'))cl='manual';return `<div class="msg ${cl}"><div>${txt}</div><div class="msg-time">${hs}</div></div>`}).join('');document.getElementById('msgs').scrollTop=document.getElementById('msgs').scrollHeight}
async function send(){const t=document.getElementById('input').value;if(!active||!t)return;document.getElementById('input').value="";await fetch('/api/send-manual',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({fono:active,texto:t})});load()}
async function tag(t){if(active)await fetch('/api/tag',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({fono:active,tag:t})});load()}
setInterval(load,2000);load();
</script></body></html>
